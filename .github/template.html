<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HCNews: A streamlined daily news update inspired by JRMUNEWS, featuring holidays, weather, and more.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“°</text></svg>">
    <title>HCNews!</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.5;
            max-width: 800px;
            margin: 0 auto;
        }
        .controls {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background-color: #1e1e1e;
            z-index: 100;
            padding-bottom: 10px;
        }
        button {
            background-color: #3794ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        button:hover { background-color: #2a75d1; }
        button.secondary { background-color: #333; color: #ccc; }
        button.secondary:hover { background-color: #444; }
        button.active { outline: 2px solid #fff; }
        
        #raw-content {
            width: 100%;
            height: 80vh;
            background-color: #2d2d2d;
            color: #d4d4d4;
            border: 1px solid #444;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            resize: vertical;
            display: none;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        #rich-content {
            white-space: pre-wrap;
            font-size: 16px;
        }
        
        /* WhatsApp style formatting */
        strong { color: #fff; font-weight: bold; }
        em { font-style: italic; color: #aaa; }
        del { text-decoration: line-through; color: #888; }
        a { color: #3794ff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        code { 
            background-color: #2d2d2d; 
            padding: 2px 4px; 
            border-radius: 3px; 
            font-family: 'Courier New', monospace;
            color: #e06c75;
        }
    </style>
</head>
<body>
    <div id="rich-content"></div>
    <textarea id="raw-content" readonly></textarea>

        <div class="controls">
        <button onclick="setView('rich')" id="btn-rich">Visual</button>
        <button onclick="setView('raw')" id="btn-raw" class="secondary">Texto cru</button>
            <label style="display:flex;align-items:center;gap:8px;">
                <input id="chk-show-links" type="checkbox" checked style="transform:scale(1.1);"> <span style="font-size:14px;">Mostrar links</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;">
                <input id="chk-short-links" type="checkbox" style="transform:scale(1.1);"> <span style="font-size:14px;">Links curtos</span>
            </label>
            <button onclick="copyRaw()" class="secondary">Copiar texto</button>
    </div>

    <!-- Hidden containers for the original injected content: full and short versions -->
    <script id="source-content" type="text/plain">
{{CONTENT_FULL}}
    </script>
    <script id="source-content-short" type="text/plain" style="display:none">
{{CONTENT_SHORT}}
    </script>

    <script>
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function stripLinks(text) {
            // Remove ONLY URLs that are part of RSS feed sections (ðŸ“° sections)
            // Keep other URLs intact.
            const lines = text.split(/\r?\n/);
            let inRss = false;
            const out = [];
            for (let i = 0; i < lines.length; i++) {
                let l = lines[i];
                // Trim trailing whitespace for cleaner output
                l = l.replace(/\s+$/g, '');
                // If a new rss portal starts
                if (/^\s*ðŸ“°\s+/.test(l)) {
                    inRss = true;
                    out.push(l);
                    continue;
                }
                // If we are in the rss section, a top-level non-prefixed line (no '-' and not whitespace) likely ends theRSS section
                if (inRss && /^[^\s-]/.test(l) && !/^\s*[-â€“â€”]/.test(l)) {
                    inRss = false;
                }

                if (inRss) {
                    // If this line is just a URL (maybe indented), skip it
                    if (/^\s*https?:\/\//i.test(l)) {
                        continue; // drop this line
                    }
                    // If it's a bullet with inline URL, remove trailing inline url
                    if (/^\s*[-â€“â€”]\s.*\shttps?:\/\//i.test(l)) {
                        l = l.replace(/\shttps?:\/\/\S+\s*$/i, '');
                    }
                }

                out.push(l);
            }
            // Join lines and preserve existing blank lines. Do not collapse multiple newlines
            // which would remove intentional paragraph spacing from the paper.
            return out.join('\n');
        }

        function parseWhatsApp(text, showLinks=true) {
            // 1. Escape HTML first to prevent injection
            // Optionally strip links before further parsing if we don't want links
            if (!showLinks) {
                text = stripLinks(text);
            }
            let parsed = escapeHtml(text);

            // 2. Code blocks (```text```)
            parsed = parsed.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>');

            // 3. Inline code (`text`)
            parsed = parsed.replace(/`([^`]+)`/g, '<code>$1</code>');

            // 4. Bold (*text*)
            parsed = parsed.replace(/\*([^*]+)\*/g, '<strong>$1</strong>');

            // 5. Italic (_text_)
            parsed = parsed.replace(/_([^_]+)_/g, '<em>$1</em>');

            // 6. Strikethrough (~text~)
            parsed = parsed.replace(/~([^~]+)~/g, '<del>$1</del>');

            // 1. Convert title + url pair into a single HTML anchor for web display.
            // Handle both cases where the url is on the same line and where it's on the following indented line.
            // - Title https://example.com/...
            // - Title\n    https://example.com/...
            const titleInlineRegex = /-\s+([^\n\r]*?)\s+(https?:\/\/[^\s]+)/g;
            parsed = parsed.replace(titleInlineRegex, '- <a href="$2" target="_blank">$1</a>');
            const titlePairRegex = /^-\s+([^\n\r]+)\r?\n\s+(https?:\/\/[^\s]+)/gm;
            parsed = parsed.replace(titlePairRegex, '- <a href="$2" target="_blank">$1</a>');

            // 2. Markdown links: [text](https://...)
            // Replace markdown link syntax with anchor tags
            const mdLinkRegex = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
            parsed = parsed.replace(mdLinkRegex, '<a href="$2" target="_blank">$1</a>');

            // 8. Links (http/https) - Simple regex for URLs
            // Only replace URLs that are standalone (preceded by line start or whitespace) to avoid touching urls already inside href attributes.
            const urlRegex = /(^|\s)(https?:\/\/[^\s]+)/g;
            parsed = parsed.replace(urlRegex, '$1<a href="$2" target="_blank">$2</a>');

            return parsed;
        }

        function setView(view) {
            const richDiv = document.getElementById('rich-content');
            const rawArea = document.getElementById('raw-content');
            const btnRich = document.getElementById('btn-rich');
            const btnRaw = document.getElementById('btn-raw');

            const showLinks = document.getElementById('chk-show-links').checked;
            const shortLinks = document.getElementById('chk-short-links').checked;

            if (view === 'rich') {
                richDiv.style.display = 'block';
                rawArea.style.display = 'none';
                btnRich.classList.remove('secondary');
                btnRaw.classList.add('secondary');
            } else {
                richDiv.style.display = 'none';
                rawArea.style.display = 'block';
                btnRich.classList.add('secondary');
                btnRaw.classList.remove('secondary');
            }

            // Re-render both views based on current checkbox state
            const sourceEl = shortLinks ? document.getElementById('source-content-short') : document.getElementById('source-content');
            const sourceText = sourceEl.textContent.replace(/^\n/, '');
            document.getElementById('raw-content').value = showLinks ? sourceText : stripLinks(sourceText);
            document.getElementById('rich-content').innerHTML = parseWhatsApp(sourceText, showLinks);

            // If short links is active, force showLinks on and disable its toggle
            const showLinksCheckbox = document.getElementById('chk-show-links');
            if (shortLinks) {
                showLinksCheckbox.checked = true;
                showLinksCheckbox.disabled = true;
            } else {
                showLinksCheckbox.disabled = false;
            }
        }

        function copyRaw() {
            const rawText = document.getElementById('raw-content');
            // If hidden, we can't select it easily, so temporarily show it or use clipboard API directly
            const wasHidden = rawText.style.display === 'none';
            if (wasHidden) {
                rawText.style.display = 'block';
                rawText.style.opacity = '0';
                rawText.style.position = 'absolute';
            }
            const showLinks = document.getElementById('chk-show-links').checked;
            const textToCopy = showLinks ? rawText.value : stripLinks(rawText.value);
            // For compatibility, we still select the field when visible
            try { rawText.select(); rawText.setSelectionRange(0, 99999); } catch (e) {}

            navigator.clipboard.writeText(textToCopy).then(() => {
                const btn = document.querySelector('button[onclick="copyRaw()"]');
                const originalText = btn.innerText;
                btn.innerText = "Copiado!";
                setTimeout(() => btn.innerText = originalText, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            }).finally(() => {
                if (wasHidden) {
                    rawText.style.display = 'none';
                    rawText.style.opacity = '';
                    rawText.style.position = '';
                }
            });
        }

        // Initialize
        window.onload = function() {
            const rawText = document.getElementById('source-content').textContent;
            // Trim the first newline if it exists (due to script tag formatting)
            const cleanText = rawText.replace(/^\n/, '');
            document.getElementById('source-content').textContent = cleanText;
            const showLinks = document.getElementById('chk-show-links').checked;
            document.getElementById('raw-content').value = showLinks ? cleanText : stripLinks(cleanText);
            document.getElementById('rich-content').innerHTML = parseWhatsApp(cleanText, showLinks);

            // Update view and bind checkbox toggle
            setView('rich');
            document.getElementById('chk-show-links').addEventListener('change', (e) => {
                const currentViewIsRaw = document.getElementById('raw-content').style.display !== 'none';
                if (currentViewIsRaw) {
                    // update raw text
                    const source = document.getElementById('source-content').textContent;
                    document.getElementById('raw-content').value = e.target.checked ? source : stripLinks(source);
                }
                // update rich view content
                const source = document.getElementById('source-content').textContent;
                document.getElementById('rich-content').innerHTML = parseWhatsApp(source, e.target.checked);
            });
            document.getElementById('chk-short-links').addEventListener('change', (e) => {
                // When short links are toggled, re-render the content from the appropriate source
                const isShort = e.target.checked;
                // If short is checked, ensure show-links is forced on and disabled
                const show = document.getElementById('chk-show-links');
                if (isShort) {
                    show.checked = true;
                    show.disabled = true;
                } else {
                    show.disabled = false;
                }
                // Re-render current view
                const currentView = document.getElementById('raw-content').style.display !== 'none' ? 'raw' : 'rich';
                setView(currentView);
            });
        };
    </script>
</body>
</html>
