name: Daily HC News

on:
  push:
    branches: [ "main", "Refactor" ]
  schedule:
    # Run once daily at 06:07 UTC (offset from top of the hour to reduce scheduling contention)
    - cron: '7 6 * * *'
  workflow_dispatch: # Allows manual triggering

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Use a Debian slim container for a smaller, reproducible environment
    container:
      image: debian:bookworm-slim
    env:
      TZ: America/Sao_Paulo
    # Prevent overlapping scheduled runs — only one instance of this job will run at a time.
    concurrency:
      group: hcnews-daily
      cancel-in-progress: false
    environment: HCNews
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install System Dependencies (slim)
        run: |
          # Keep this list minimal: the scripts rely on xmlstarlet, jq and curl
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends xmlstarlet jq curl python3 file ca-certificates unzip
          # Use prebuilt pup binary instead of installing Go (slimmer)
          # Download the latest pup binary asset for linux/amd64 and validate it's a binary
          set -euxo pipefail
          # Try a handful of pup asset names (release asset names change occasionally)
          PUP_ASSETS=(pup_linux_amd64 pup_linux_x86_64 pup_linux_x64 pup_linux_amd64.zip pup_linux_x86_64.tar.gz)
          PUP_URL_BASE='https://github.com/ericchiang/pup/releases/latest/download'
          dl_ok=false
          for asset in "${PUP_ASSETS[@]}"; do
            echo "Trying asset: $asset"
            if curl -fsSL -o pup "${PUP_URL_BASE}/${asset}"; then
              # If it's an archive, try to extract; otherwise keep as binary
              if file pup | grep -qi 'Zip archive\|gzip compressed data'; then
                mkdir -p /tmp/pupdl
                if file pup | grep -qi 'Zip archive'; then
                  unzip -o pup -d /tmp/pupdl || true
                else
                  tar -xzf pup -C /tmp/pupdl || true
                fi
                # find bin
                if [ -f /tmp/pupdl/pup ]; then
                  sudo mv /tmp/pupdl/pup /usr/local/bin/pup
                  rm -rf /tmp/pupdl
                fi
              else
                sudo mv pup /usr/local/bin/pup
              fi
              sudo chmod +x /usr/local/bin/pup
              if file /usr/local/bin/pup | grep -qi 'ELF'; then
                dl_ok=true
                break
              fi
            fi
          done
          if [ "$dl_ok" = false ]; then
            echo 'Failed to download a prebuilt pup binary; falling back to building from source'
            sudo apt-get update && sudo apt-get install -y --no-install-recommends golang-go git build-essential
            export GOPATH="/tmp/go"
            mkdir -p "$GOPATH/bin"
            GOPATH=$GOPATH PATH=$PATH:$GOPATH/bin go install github.com/ericchiang/pup@latest
            sudo mv "$GOPATH/bin/pup" /usr/local/bin/pup
            sudo chmod +x /usr/local/bin/pup
          fi
          # Validate pup is an ELF binary and works by running a small test
          if ! file /usr/local/bin/pup | grep -qi 'ELF'; then
            echo 'pup download does not appear to be a binary' >&2
            file /usr/local/bin/pup
            exit 1
          fi
          /usr/local/bin/pup -v || true
          echo '<div><p>pup-test</p></div>' | /usr/local/bin/pup 'p text{}' || (echo 'pup test failed' >&2; exit 1)

      - name: Verify installed tools
        run: |
          echo "== Tools versions =="
          for cmd in xmlstarlet jq curl pup python3 file unzip; do
            if command -v $cmd >/dev/null 2>&1; then
              echo "$cmd: $(command -v $cmd)";
            else
              echo "::warning::$cmd not found";
            fi
          done

      - name: Print Timezone (container)
        run: |
          echo "TZ=${TZ}"
          date

      - name: Run HC News Script
        id: run_script
        run: |
          set -euxo pipefail
          export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          export CoinMarketCap_API_KEY="${{ secrets.COINMARKETCAP_API_KEY }}"
          export openweathermap_API_KEY="${{ secrets.OPENWEATHERMAP_API_KEY }}"
          
          # Check if secrets are set
          if [ -z "$GEMINI_API_KEY" ]; then echo "::warning::GEMINI_API_KEY is empty"; fi
          if [ -z "$CoinMarketCap_API_KEY" ]; then echo "::warning::CoinMarketCap_API_KEY is empty"; fi
          if [ -z "$openweathermap_API_KEY" ]; then echo "::warning::openweathermap_API_KEY is empty"; fi
          
          chmod +x hcnews.sh
          # Quick sanity check: show help to verify it's runnable and required tools are in PATH
          ./hcnews.sh --help
          # Run the script and capture output to a file
          ./hcnews.sh --force > news_output.txt
          if [ ! -s news_output.txt ]; then
            echo 'news_output.txt is empty — exitting' >&2
            tail -100 news_output.txt || true
            exit 1
          fi

      - name: Generate HTML
        run: |
          # Create a clean public directory for deployment
          mkdir -p public

          # Create a simple HTML wrapper
          cat <<EOF > public/index.html
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>HC News - $(date +'%d/%m/%Y')</title>
              <style>
                  body { 
                      font-family: 'Courier New', Courier, monospace; 
                      white-space: pre-wrap; 
                      background-color: #1e1e1e; 
                      color: #d4d4d4; 
                      padding: 20px; 
                      line-height: 1.5;
                      max-width: 800px;
                      margin: 0 auto;
                  }
                  a { color: #3794ff; text-decoration: none; }
                  a:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
          EOF
          
          # Append the news content (HTML escaped to prevent breakage)
          # We use python to escape HTML characters safely
          python3 -c "import sys, html; print(html.escape(sys.stdin.read()))" < news_output.txt >> public/index.html
          
          cat <<EOF >> public/index.html
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: false
          publish_branch: gh-pages
